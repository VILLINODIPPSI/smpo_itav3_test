<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMPO - Generatore Link Partecipanti</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-top: 0;
            text-align: center;
        }
        h2 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .url-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        .inline-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 80px 120px auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button.success {
            background: #48bb78;
        }
        button.success:hover {
            background: #38a169;
        }
        button.danger {
            background: #f56565;
        }
        button.danger:hover {
            background: #e53e3e;
        }
        button.small {
            padding: 6px 12px;
            font-size: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        table td {
            padding: 10px 8px;
            border-bottom: 1px solid #ddd;
        }
        table tr:hover {
            background: #f5f5f5;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .condition-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            display: inline-block;
        }
        .condition-1 {
            background: #fee;
            color: #c33;
        }
        .condition-2 {
            background: #efe;
            color: #3c3;
        }
        .condition-3 {
            background: #eef;
            color: #33c;
        }
        .link-cell {
            font-family: monospace;
            font-size: 11px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .copy-btn {
            margin-left: 10px;
            padding: 4px 8px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó SMPO - Generatore Link Partecipanti</h1>
        
        <div class="info-box">
            <strong>üìã Gestione Partecipanti SMPO</strong><br>
            Questo strumento ti permette di gestire i partecipanti, assegnare condizioni e generare automaticamente i link personalizzati per l'esperimento SMPO.
        </div>

        <h2>‚öôÔ∏è Configurazione Base URL</h2>
        <div class="url-section">
            <div class="form-group">
                <label>URL Base SMPO:</label>
                <input type="text" id="baseUrl" value="https://villinodippsi.github.io/smpo-socialmedia-ita/index.html" placeholder="URL base del paradigma SMPO">
            </div>
            <div class="form-group">
                <label>URL Questionario (non codificato):</label>
                <input type="text" id="surveyUrl" placeholder="es. https://tuodominio.qualtrics.com/jfe/form/SV_CODICE">
            </div>
            <div class="form-group">
                <label>URL Questionario Codificato:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="encodedUrl" readonly style="background: #f0f0f0;">
                    <button onclick="encodeUrl()">üîê Codifica</button>
                    <button class="copy-btn" onclick="copyEncodedUrl()">üìã Copia</button>
                </div>
            </div>
        </div>

        <h2>‚ûï Aggiungi Partecipante</h2>
        <div class="inline-form">
            <input type="text" id="nome" placeholder="Nome">
            <input type="text" id="cognome" placeholder="Cognome">
            <input type="date" id="dataNascita">
            <select id="sesso">
                <option value="">Sesso</option>
                <option value="M">M</option>
                <option value="F">F</option>
            </select>
            <input type="number" id="manualId" placeholder="ID" min="1">
            <select id="condizione">
                <option value="">Condizione</option>
                <option value="1">1 - OSTRACISMO</option>
                <option value="2">2 - INCLUSIONE</option>
                <option value="3">3 - SOVRAINCLUSIONE</option>
            </select>
            <button onclick="addParticipant()">‚ûï Aggiungi</button>
        </div>

        <div class="warning-box">
            <strong>üí° Suggerimento:</strong> Lascia il campo ID vuoto per assegnazione automatica, oppure inserisci un ID specifico.
        </div>

        <h2>üìä Statistiche</h2>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Totale Partecipanti</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cond1Count">0</div>
                <div class="stat-label">Ostracismo (c=1)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cond2Count">0</div>
                <div class="stat-label">Inclusione (c=2)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cond3Count">0</div>
                <div class="stat-label">Sovrainclusione (c=3)</div>
            </div>
        </div>

        <h2>üë• Elenco Partecipanti</h2>
        <div class="table-container">
            <table id="participantsTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Cognome</th>
                        <th>Data Nascita</th>
                        <th>Sesso</th>
                        <th>ID</th>
                        <th>Condizione</th>
                        <th>Link Partecipazione</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="participantsBody">
                </tbody>
            </table>
        </div>

        <div class="action-buttons">
            <button class="success" onclick="generateLinks()">üîó Genera/Aggiorna Link</button>
            <button onclick="exportCSV()">üì• Esporta CSV</button>
            <button onclick="importCSV()">üìÇ Importa CSV</button>
            <button onclick="generateBulk()">‚ö° Genera Multipli</button>
            <button onclick="autoAssignConditions()">üéØ Auto-Bilancia Condizioni</button>
            <button class="danger" onclick="clearAll()">üóëÔ∏è Cancella Tutto</button>
        </div>

        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
    </div>

    <script>
        let participants = [];
        let nextId = 1;

        function encodeUrl() {
            const surveyUrl = document.getElementById('surveyUrl').value;
            if (!surveyUrl) {
                alert('Inserisci prima l\'URL del questionario!');
                return;
            }
            const encoded = encodeURIComponent(surveyUrl);
            document.getElementById('encodedUrl').value = encoded;
        }

        function copyEncodedUrl() {
            const encodedUrl = document.getElementById('encodedUrl').value;
            if (!encodedUrl) {
                alert('Prima devi codificare l\'URL!');
                return;
            }
            navigator.clipboard.writeText(encodedUrl).then(() => {
                alert('‚úÖ URL codificato copiato negli appunti!');
            });
        }

        function generateLink(id, condition) {
            const baseUrl = document.getElementById('baseUrl').value;
            const encodedUrl = document.getElementById('encodedUrl').value;
            
            if (!encodedUrl) {
                return '[CONFIGURA URL QUESTIONARIO]';
            }
            
            return `${baseUrl}?c=${condition}&p=${id}&redirect=${encodedUrl}`;
        }

        function addParticipant() {
            const nome = document.getElementById('nome').value.trim();
            const cognome = document.getElementById('cognome').value.trim();
            const dataNascita = document.getElementById('dataNascita').value;
            const sesso = document.getElementById('sesso').value;
            const manualId = document.getElementById('manualId').value;
            const condizione = document.getElementById('condizione').value;

            if (!nome || !cognome || !dataNascita || !sesso || !condizione) {
                alert('Compila tutti i campi obbligatori!');
                return;
            }

            const id = manualId ? parseInt(manualId) : nextId;
            
            // Verifica che l'ID non esista gi√†
            if (participants.some(p => p.id === id)) {
                alert(`ID ${id} gi√† esistente! Scegli un altro ID.`);
                return;
            }

            const participant = {
                nome,
                cognome,
                dataNascita,
                sesso,
                id,
                condizione: parseInt(condizione),
                link: generateLink(id, condizione)
            };

            participants.push(participant);
            
            // Aggiorna nextId
            nextId = Math.max(...participants.map(p => p.id)) + 1;

            // Reset form
            document.getElementById('nome').value = '';
            document.getElementById('cognome').value = '';
            document.getElementById('dataNascita').value = '';
            document.getElementById('sesso').value = '';
            document.getElementById('manualId').value = '';
            document.getElementById('condizione').value = '';

            updateTable();
            updateStats();
        }

        function deleteParticipant(id) {
            if (confirm('Sei sicuro di voler eliminare questo partecipante?')) {
                participants = participants.filter(p => p.id !== id);
                updateTable();
                updateStats();
            }
        }

        function updateTable() {
            const tbody = document.getElementById('participantsBody');
            tbody.innerHTML = '';

            participants.sort((a, b) => a.id - b.id).forEach(p => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${p.nome}</td>
                    <td>${p.cognome}</td>
                    <td>${p.dataNascita}</td>
                    <td>${p.sesso}</td>
                    <td><strong>${p.id}</strong></td>
                    <td><span class="condition-badge condition-${p.condizione}">C${p.condizione}</span></td>
                    <td class="link-cell" title="${p.link}">${p.link}</td>
                    <td>
                        <button class="small danger" onclick="deleteParticipant(${p.id})">üóëÔ∏è</button>
                        <button class="small" onclick="copyLink(${p.id})">üìã</button>
                    </td>
                `;
            });
        }

        function copyLink(id) {
            const participant = participants.find(p => p.id === id);
            if (participant) {
                navigator.clipboard.writeText(participant.link).then(() => {
                    alert(`‚úÖ Link copiato per ${participant.nome} ${participant.cognome}`);
                });
            }
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = participants.length;
            document.getElementById('cond1Count').textContent = participants.filter(p => p.condizione === 1).length;
            document.getElementById('cond2Count').textContent = participants.filter(p => p.condizione === 2).length;
            document.getElementById('cond3Count').textContent = participants.filter(p => p.condizione === 3).length;
        }

        function generateLinks() {
            if (participants.length === 0) {
                alert('Nessun partecipante da aggiornare!');
                return;
            }

            participants.forEach(p => {
                p.link = generateLink(p.id, p.condizione);
            });

            updateTable();
            alert('‚úÖ Link aggiornati per tutti i partecipanti!');
        }

        function exportCSV() {
            if (participants.length === 0) {
                alert('Nessun partecipante da esportare!');
                return;
            }

            let csv = 'Nome,Cognome,Data_Nascita,Sesso,ID,Condizione,Link_Partecipazione\n';
            
            participants.sort((a, b) => a.id - b.id).forEach(p => {
                csv += `${p.nome},${p.cognome},${p.dataNascita},${p.sesso},${p.id},${p.condizione},"${p.link}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'partecipanti_smpo_ita.csv';
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ File CSV esportato!');
        }

        function importCSV() {
            document.getElementById('csvFileInput').click();
        }

        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const lines = content.split('\n');
                
                // Skip header
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const parts = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                    if (!parts || parts.length < 6) continue;

                    const cleanPart = (part) => part.replace(/^"|"$/g, '').trim();

                    const participant = {
                        nome: cleanPart(parts[0]),
                        cognome: cleanPart(parts[1]),
                        dataNascita: cleanPart(parts[2]),
                        sesso: cleanPart(parts[3]),
                        id: parseInt(cleanPart(parts[4])),
                        condizione: parseInt(cleanPart(parts[5])),
                        link: parts[6] ? cleanPart(parts[6]) : ''
                    };

                    if (participant.nome && participant.cognome && participant.id) {
                        // Verifica che non esista gi√†
                        if (!participants.some(p => p.id === participant.id)) {
                            participants.push(participant);
                        }
                    }
                }

                nextId = Math.max(...participants.map(p => p.id), 0) + 1;
                updateTable();
                updateStats();
                alert(`‚úÖ Importati ${participants.length} partecipanti!`);
            };

            reader.readAsText(file);
        }

        function generateBulk() {
            const count = prompt('Quanti partecipanti vuoi generare?', '10');
            if (!count) return;

            const num = parseInt(count);
            if (isNaN(num) || num < 1 || num > 1000) {
                alert('Inserisci un numero valido tra 1 e 1000!');
                return;
            }

            const names = ['Marco', 'Giulia', 'Alessandro', 'Francesca', 'Luca', 'Martina', 'Andrea', 'Sara', 'Matteo', 'Chiara'];
            const surnames = ['Rossi', 'Bianchi', 'Verdi', 'Romano', 'Colombo', 'Ferrari', 'Esposito', 'Ricci', 'Bruno', 'Gallo'];

            for (let i = 0; i < num; i++) {
                const nome = names[Math.floor(Math.random() * names.length)];
                const cognome = surnames[Math.floor(Math.random() * surnames.length)];
                const year = 1990 + Math.floor(Math.random() * 10);
                const month = String(1 + Math.floor(Math.random() * 12)).padStart(2, '0');
                const day = String(1 + Math.floor(Math.random() * 28)).padStart(2, '0');
                const dataNascita = `${year}-${month}-${day}`;
                const sesso = Math.random() > 0.5 ? 'M' : 'F';
                const condizione = (i % 3) + 1;

                const participant = {
                    nome: `${nome}${i + 1}`,
                    cognome,
                    dataNascita,
                    sesso,
                    id: nextId++,
                    condizione,
                    link: generateLink(nextId - 1, condizione)
                };

                participants.push(participant);
            }

            updateTable();
            updateStats();
            alert(`‚úÖ Generati ${num} partecipanti di esempio!`);
        }

        function autoAssignConditions() {
            if (participants.length === 0) {
                alert('Nessun partecipante da bilanciare!');
                return;
            }

            if (!confirm('Questo sovrascriver√† le condizioni esistenti. Continuare?')) {
                return;
            }

            participants.forEach((p, index) => {
                p.condizione = (index % 3) + 1;
                p.link = generateLink(p.id, p.condizione);
            });

            updateTable();
            updateStats();
            alert('‚úÖ Condizioni bilanciate automaticamente!');
        }

        function clearAll() {
            if (confirm('Sei sicuro di voler cancellare tutti i partecipanti?')) {
                participants = [];
                nextId = 1;
                updateTable();
                updateStats();
                alert('üóëÔ∏è Tutti i partecipanti eliminati!');
            }
        }

        // Inizializza
        updateStats();
    </script>
</body>
</html>